<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>·ª®NG D·ª§NG AI NH·∫¨N DI·ªÜN LINH KI·ªÜN ƒêI·ªÜN T·ª¨</title>

  <!-- Th∆∞ vi·ªán TensorFlow v√† Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

  <style>
    :root {
      --accent:#0b6cf0;
      --bg:#f7fbff;
      --card:#ffffff;
      --muted:#666;
      --radius:16px;
    }
    html,body {
      height:100%;
      margin:0;
      font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:linear-gradient(180deg,#f0f6ff 0%, #ffffff 100%);
      color:#111;
    }

    .container {
      max-width:900px;
      margin:0 auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:100vh;
      box-sizing:border-box;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .title {
      font-size:20px;
      font-weight:700;
      color:var(--accent);
    }

    .subtitle {
      font-size:12px;
      color:var(--muted);
    }

    .card {
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 6px 20px rgba(12,40,80,0.06);
      padding:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    #video-container {
      width:100%;
      max-width:540px;
      aspect-ratio:9/16;
      background:#000;
      border-radius:12px;
      overflow:hidden;
      position:relative;
    }
    video {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .controls {
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    button {
      border:0;
      background:var(--accent);
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
    }

    button.secondary {
      background:#e6f0ff;
      color:var(--accent);
      font-weight:700;
    }

    .info {
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .label-list {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .pill {
      background:#f1f7ff;
      padding:6px 10px;
      border-radius:999px;
      color:var(--accent);
      font-weight:700;
      font-size:13px;
    }

    .details {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .row {
      background:#fbfdff;
      padding:8px;
      border-radius:8px;
    }

    .small {
      font-size:13px;
      color:var(--muted);
    }

    footer {
      margin-top:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width:520px){
      .title { font-size:18px; }
      #video-container { height:140px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <div class="title">·ª®NG D·ª§NG AI NH·∫¨N DI·ªÜN LINH KI·ªÜN ƒêI·ªÜN T·ª¨</div>
        <div class="subtitle small">·ª®ng d·ª•ng AI trong d·∫°y h·ªçc m√¥n C√¥ng ngh·ªá</div>
      </div>
      <div style="text-align:right;font-size:12px;color:var(--muted)">Tr∆∞·ªùng THPT Tr·∫ßn Qu·ªëc Tu·∫•n</div>
    </header>

    <div class="card">
      <div id="video-container">
        <video id="webcam" playsinline autoplay muted></video>
      </div>

      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
          <button id="stopBtn" class="secondary">D·ª´ng</button>
          <button id="flipBtn" class="secondary">Chuy·ªÉn camera</button>
        </div>
        <div style="text-align:right;font-size:13px;color:var(--muted);">
          <div id="status">Tr·∫°ng th√°i: Ch∆∞a s·∫µn s√†ng</div>
        </div>
      </div>

      <div class="info">
        <div class="label-list" id="predictions"></div>

        <div class="details">
          <div class="row">
            <div style="font-weight:700" id="detectedName">‚Äî</div>
            <div class="small" id="detectedScore">‚Äî</div>
          </div>

          <div class="row">
            <div style="font-weight:700">C√¥ng d·ª•ng</div>
            <div id="func">‚Äî</div>
          </div>

          <div class="row">
            <div style="font-weight:700">C·∫•u t·∫°o</div>
            <div id="structure">‚Äî</div>
          </div>

          <div class="row">
            <div style="font-weight:700">Nguy√™n l√Ω ho·∫°t ƒë·ªông</div>
            <div id="principle">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="small">·ª®ng d·ª•ng AI trong d·∫°y h·ªçc m√¥n C√¥ng ngh·ªá</div>
      <div class="small">¬© Tr∆∞·ªùng THPT Tr·∫ßn Qu·ªëc Tu·∫•n</div>
    </footer>
  </div>

  <script>
    // ‚úÖ ƒê∆∞·ªùng d·∫´n model
    const MODEL_URL = "./model/model.json";

    // ‚úÖ CSDL th√¥ng tin linh ki·ªán
    const INFO_DB = {
      "ƒêi·ªán tr·ªü": {
        name: "ƒêi·ªán tr·ªü (Resistor)",
        function: "Gi·ªõi h·∫°n d√≤ng ƒëi·ªán v√† chia ƒëi·ªán √°p trong m·∫°ch ƒëi·ªán.",
        structure: "Th√¢n g·ªëm ho·∫∑c film c√≥ hai ch√¢n kim lo·∫°i ·ªü hai ƒë·∫ßu.",
        principle: "Ho·∫°t ƒë·ªông theo ƒë·ªãnh lu·∫≠t Ohm: U = I √ó R."
      },
      "T·ª• ƒëi·ªán": {
        name: "T·ª• ƒëi·ªán (Capacitor)",
        function: "T√≠ch v√† ph√≥ng ƒëi·ªán, gi√∫p l·ªçc nhi·ªÖu ho·∫∑c ·ªïn ƒë·ªãnh ƒëi·ªán √°p.",
        structure: "Hai b·∫£n d·∫´n song song ngƒÉn c√°ch b·ªüi l·ªõp ƒëi·ªán m√¥i.",
        principle: "Khi c√≥ hi·ªáu ƒëi·ªán th·∫ø, c√°c b·∫£n t·ª• t√≠ch ƒëi·ªán tr√°i d·∫•u."
      },
      "Cu·ªôn c·∫£m": {
        name: "Cu·ªôn c·∫£m (Inductor)",
        function: "T·∫°o ra t·ª´ tr∆∞·ªùng khi c√≥ d√≤ng ƒëi·ªán ch·∫°y qua, d√πng ƒë·ªÉ l·ªçc nhi·ªÖu ho·∫∑c t√≠ch nƒÉng l∆∞·ª£ng t·ª´.",
        structure: "Cu·ªôn d√¢y d·∫´n qu·∫•n quanh l√µi s·∫Øt t·ª´ ho·∫∑c l√µi kh√¥ng kh√≠.",
        principle: "D·ª±a v√†o hi·ªán t∆∞·ª£ng c·∫£m ·ª©ng ƒëi·ªán t·ª´."
      }
    };

    let model, webcam, maxPredictions;
    let usingFacingMode = "environment";

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const flipBtn = document.getElementById('flipBtn');
    const statusEl = document.getElementById('status');
    const predictionsEl = document.getElementById('predictions');
    const detectedNameEl = document.getElementById('detectedName');
    const detectedScoreEl = document.getElementById('detectedScore');
    const funcEl = document.getElementById('func');
    const structureEl = document.getElementById('structure');
    const principleEl = document.getElementById('principle');

    async function initModel() {
      statusEl.textContent = "ƒêang t·∫£i model...";
      try {
        const modelURL = MODEL_URL;
        const metadataURL = "./model/metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        statusEl.textContent = "‚úÖ Model ƒë√£ s·∫µn s√†ng. Nh·∫•n 'B·∫Øt ƒë·∫ßu' ƒë·ªÉ nh·∫≠n di·ªán.";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "‚ùå L·ªói t·∫£i model. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n /model.";
      }
    }

    async function startWebcam(){
      const video = document.getElementById('webcam');
      if (webcam && webcam.stream) stopWebcam();
      statusEl.textContent = "Y√™u c·∫ßu quy·ªÅn camera...";
      const constraints = { video: { facingMode: usingFacingMode }, audio: false };
      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        webcam = { stream, video };
        statusEl.textContent = "üé• Camera ƒë√£ k·∫øt n·ªëi. ƒêang nh·∫≠n di·ªán...";
        runPredictionLoop();
      } catch(e){
        console.error(e);
        statusEl.textContent = "‚ö†Ô∏è Kh√¥ng th·ªÉ truy c·∫≠p camera.";
      }
    }

    function stopWebcam(){
      if (webcam && webcam.stream) webcam.stream.getTracks().forEach(t => t.stop());
      webcam = null;
      statusEl.textContent = "‚èπÔ∏è Camera ƒë√£ d·ª´ng.";
    }

    flipBtn.addEventListener('click', async ()=>{
      usingFacingMode = usingFacingMode === "environment" ? "user" : "environment";
      await startWebcam();
    });
    startBtn.addEventListener('click', startWebcam);
    stopBtn.addEventListener('click', stopWebcam);

    async function runPredictionLoop(){
      if (!model || !webcam) return;
      const video = webcam.video;
      async function loop(){
        if (!webcam) return;
        const prediction = await model.predict(video);
        showPredictions(prediction);
        setTimeout(()=>requestAnimationFrame(loop), 200);
      }
      loop();
    }

    function showPredictions(preds){
      preds.sort((a,b)=>b.probability-a.probability);
      const top = preds[0];
      predictionsEl.innerHTML = preds.slice(0,3).map(p=>`<div class="pill">${p.className} ${(p.probability*100).toFixed(0)}%</div>`).join('');
      if (top){
        const info = INFO_DB[top.className];
        detectedNameEl.textContent = info ? info.name : top.className;
        detectedScoreEl.textContent = `ƒê·ªô t·ª± tin: ${(top.probability*100).toFixed(1)}%`;
        funcEl.textContent = info ? info.function : "‚Äî";
        structureEl.textContent = info ? info.structure : "‚Äî";
        principleEl.textContent = info ? info.principle : "‚Äî";
      }
    }

    (async()=>{await initModel();})();
  </script>
</body>
</html>
